#!/usr/bin/env php
<?php declare(strict_types=1);

/**
 * Generates JSON snapshots for ruleset and sniff tests.
 *
 * Usage:
 *   php bin/snapshots                    # Generate all snapshots
 *   php bin/snapshots --set=8.0          # Generate only set 8.0
 *   php bin/snapshots --sniffs           # Generate only sniff snapshots
 *   php bin/snapshots --sniff=Generic.Arrays.DisallowLongArraySyntax
 *   php bin/snapshots --issues           # Generate only issue snapshots
 *   php bin/snapshots --issue=19         # Generate only specific issue snapshot
 */

$rootDir = dirname(__DIR__);

require $rootDir . '/vendor/autoload.php';
require $rootDir . '/tests/Toolkit/Codesniffer.php';

use Nette\Utils\Finder;
use Symfony\Component\Process\Process;
use Tests\Toolkit\Codesniffer;

// Parse CLI arguments
$filterSet = null;
$filterSniff = null;
$filterIssue = null;
$sniffsOnly = false;
$setsOnly = false;
$issuesOnly = false;

foreach ($argv as $arg) {
	if (str_starts_with($arg, '--set=')) {
		$filterSet = substr($arg, 6);
		$setsOnly = true;
	}

	if (str_starts_with($arg, '--sniff=')) {
		$filterSniff = substr($arg, 8);
		$sniffsOnly = true;
	}

	if (str_starts_with($arg, '--issue=')) {
		$filterIssue = substr($arg, 8);
		$issuesOnly = true;
	}

	if ($arg === '--sniffs') {
		$sniffsOnly = true;
	}

	if ($arg === '--sets') {
		$setsOnly = true;
	}

	if ($arg === '--issues') {
		$issuesOnly = true;
	}
}

// ============================================================================
// Part 1: Generate Set Snapshots
// ============================================================================

if (!$sniffsOnly && !$issuesOnly) {
	$setsDir = $rootDir . '/tests/Sets';

	echo "=== Generating Set Snapshots ===\n\n";

	$generated = 0;
	$failed = 0;

	if (is_dir($setsDir)) {
		foreach (Finder::findDirectories('*')->in($setsDir) as $setDir) {
			$setName = $setDir->getBasename();

			if ($filterSet !== null && $filterSet !== $setName) {
				continue;
			}

			$ruleset = $setDir->getPathname() . '/ruleset.xml';
			$fixturesDir = $setDir->getPathname() . '/Fixtures';
			$outputPath = $setDir->getPathname() . '/snapshot.json';

			if (!file_exists($ruleset)) {
				echo "Warning: Ruleset not found: {$ruleset}\n";

				continue;
			}

			if (!is_dir($fixturesDir)) {
				echo "Warning: Fixtures directory not found: {$fixturesDir}\n";

				continue;
			}

			$process = new Process([
				'vendor/bin/phpcs',
				'--standard=' . $ruleset,
				'--report=json',
				'-q',
				$fixturesDir,
			], $rootDir);
			$process->run();

			$output = $process->getOutput();
			$data = json_decode($output, true);

			if ($data === null) {
				echo "Error: Failed to parse phpcs output for {$setName}\n";
				$failed++;

				continue;
			}

			$normalized = Codesniffer::normalize($data);
			$json = json_encode($normalized, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . "\n";

			file_put_contents($outputPath, $json);
			$errorCount = $normalized['totals']['errors'];
			$warningCount = $normalized['totals']['warnings'];
			$fileCount = count($normalized['files']);
			echo "Generated: Sets/{$setName}/snapshot.json ({$fileCount} files, {$errorCount} errors, {$warningCount} warnings)\n";
			$generated++;
		}
	}

	echo "\nSet snapshots: {$generated} generated";

	if ($failed > 0) {
		echo ", {$failed} failed";
	}

	echo ".\n";
}

// ============================================================================
// Part 2: Generate Sniff Snapshots
// ============================================================================

if (!$setsOnly && !$issuesOnly) {
	$sniffsDir = $rootDir . '/tests/Sniffs';

	echo "\n=== Generating Sniff Snapshots ===\n\n";

	$generated = 0;
	$skipped = 0;

	if (is_dir($sniffsDir)) {
		// Find all category directories (e.g., Generic.Arrays)
		foreach (Finder::findDirectories('*')->in($sniffsDir) as $categoryDir) {
			$categoryName = $categoryDir->getBasename();

			// Find all sniff directories (e.g., DisallowLongArraySyntax)
			foreach (Finder::findDirectories('*')->in($categoryDir->getPathname()) as $sniffDir) {
				$sniffName = $sniffDir->getBasename();
				$fullSniff = $categoryName . '.' . $sniffName;

				if ($filterSniff !== null && $filterSniff !== $fullSniff) {
					continue;
				}

				// Find all PHP test files in the sniff directory
				foreach (Finder::findFiles('*.php')->in($sniffDir->getPathname()) as $phpFile) {
					$baseName = $phpFile->getBasename('.php');
					$snapshotPath = $sniffDir->getPathname() . '/' . $baseName . '.snapshot.json';
					$rulesetPath = $sniffDir->getPathname() . '/' . $baseName . '.ruleset.xml';

					if (!file_exists($rulesetPath)) {
						echo "Warning: Ruleset not found: {$rulesetPath}\n";

						continue;
					}

					$process = new Process([
						'vendor/bin/phpcs',
						'--standard=' . $rulesetPath,
						'--report=json',
						'-q',
						$phpFile->getPathname(),
					], $rootDir);
					$process->run();

					$data = json_decode($process->getOutput(), true);

					if ($data === null) {
						echo "Error: Failed to parse phpcs output for {$fullSniff}/{$baseName}.php\n";

						continue;
					}

					$normalized = Codesniffer::normalize($data);
					$json = json_encode($normalized, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . "\n";

					file_put_contents($snapshotPath, $json);

					$errorCount = $normalized['totals']['errors'];
					$warningCount = $normalized['totals']['warnings'];
					echo "Generated: Sniffs/{$categoryName}/{$sniffName}/{$baseName}.snapshot.json ({$errorCount} errors, {$warningCount} warnings)\n";
					$generated++;
				}
			}
		}
	} else {
		echo "No Sniffs directory found.\n";
	}

	echo "\nSniff snapshots: {$generated} generated.\n";
}

// ============================================================================
// Part 3: Generate Issue Snapshots
// ============================================================================

if (!$setsOnly && !$sniffsOnly) {
	$issuesDir = $rootDir . '/tests/Issue';

	echo "\n=== Generating Issue Snapshots ===\n\n";

	$generated = 0;

	if (is_dir($issuesDir)) {
		// Find all issue directories (e.g., 19)
		foreach (Finder::findDirectories('*')->in($issuesDir) as $issueDir) {
			$issueName = $issueDir->getBasename();

			if ($filterIssue !== null && $filterIssue !== $issueName) {
				continue;
			}

			// Find all PHP test files in the issue directory
			foreach (Finder::findFiles('*.php')->in($issueDir->getPathname()) as $phpFile) {
				$baseName = $phpFile->getBasename('.php');
				$snapshotPath = $issueDir->getPathname() . '/' . $baseName . '.snapshot.json';
				$rulesetPath = $issueDir->getPathname() . '/' . $baseName . '.ruleset.xml';

				if (!file_exists($rulesetPath)) {
					echo "Warning: Ruleset not found: {$rulesetPath}\n";

					continue;
				}

				$process = new Process([
					'vendor/bin/phpcs',
					'--standard=' . $rulesetPath,
					'--report=json',
					'-q',
					$phpFile->getPathname(),
				], $rootDir);
				$process->run();

				$data = json_decode($process->getOutput(), true);

				if ($data === null) {
					echo "Error: Failed to parse phpcs output for Issue/{$issueName}/{$baseName}.php\n";

					continue;
				}

				$normalized = Codesniffer::normalize($data);
				$json = json_encode($normalized, JSON_PRETTY_PRINT | JSON_UNESCAPED_SLASHES) . "\n";

				file_put_contents($snapshotPath, $json);

				$errorCount = $normalized['totals']['errors'];
				$warningCount = $normalized['totals']['warnings'];
				echo "Generated: Issue/{$issueName}/{$baseName}.snapshot.json ({$errorCount} errors, {$warningCount} warnings)\n";
				$generated++;
			}
		}
	} else {
		echo "No Issue directory found.\n";
	}

	echo "\nIssue snapshots: {$generated} generated.\n";
}

echo "\nDone!\n";
